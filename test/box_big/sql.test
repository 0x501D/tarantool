# encoding: tarantool
#
print """#
# A test case for Bug#729758
# "SELECT fails with a disjunct and small LIMIT"
# https://bugs.launchpad.net/tarantool/+bug/729758
#"""

exec sql "insert into t0 values ('Doe', 'Richard')"
exec sql "insert into t0 values ('Roe', 'Richard')"
exec sql "insert into t0 values ('Woe', 'Richard')"
exec sql "insert into t0 values ('Major', 'Tomas')"
exec sql "insert into t0 values ('Kytes', 'Tomas')"
exec sql "insert into t0 values ('Stiles', 'Tomas')"
exec sql "insert into t0 values ('Wales', 'Tomas')"
exec sql "insert into t0 values ('Callaghan', 'Tomas')"
exec sql "select * from t0 where k1='Richard' or k1='Tomas' or k1='Tomas' limit 5"

print """#
# A test case for Bug#729879
# "Zero limit is treated the same as no limit"
# https://bugs.launchpad.net/tarantool/+bug/729879
#"""
exec sql "select * from t0 where k1='Richard' or k1='Tomas' limit 0"

# Cleanup
exec sql "delete from t0 where k0='Doe'"
exec sql "delete from t0 where k0='Roe'"
exec sql "delete from t0 where k0='Woe'"
exec sql "delete from t0 where k0='Major'"
exec sql "delete from t0 where k0='Kytes'"
exec sql "delete from t0 where k0='Stiles'"
exec sql "delete from t0 where k0='Wales'"
exec sql "delete from t0 where k0='Callaghan'"

print """#
# A test case for Bug#730593
# "Bad data if incomplete tuple"
# https://bugs.launchpad.net/tarantool/+bug/730593
# Verify that if there is an index on, say, field 2,
# we can't insert tuples with cardinality 1 and
# get away with it.
#"""
exec sql "insert into t0 values ('Britney')"
exec sql "select * from t0 where k1='Anything'"
exec sql "insert into t0 values ('Stephanie')"
exec sql "select * from t0 where k1='Anything'"
exec sql "insert into t0 values ('Spears', 'Britney')"
exec sql "select * from t0 where k0='Spears'"
exec sql "select * from t0 where k1='Anything'"
exec sql "select * from t0 where k1='Britney'"
exec sql "delete from t0 where k0='Spears'"
print """#
# Test composite keys with trees
#"""
exec sql "insert into t1 values ('key1', 'part1', 'part2')"
exec sql "insert into t1 values ('key2', 'part1', 'part2_a')"
exec sql "insert into t1 values ('key3', 'part1', 'part2_b')"
exec sql "select * from t1 where k0='key1'"
exec sql "select * from t1 where k0='key2'"
exec sql "select * from t1 where k0='key3'"
exec sql "select * from t1 where k1='part1'"
# Check how build_idnexes() works
server.stop()
server.start()
exec sql "select * from t1 where k0='key1'"
exec sql "select * from t1 where k0='key2'"
exec sql "select * from t1 where k0='key3'"
exec sql "select * from t1 where k1='part1'"
exec sql "delete from t1 where k0='key1'"
exec sql "delete from t1 where k0='key2'"
exec sql "delete from t1 where k0='key3'"

print """
#
# A test case for: http://bugs.launchpad.net/bugs/735140
# Partial REPLACE corrupts index.
#
"""
# clean data and restart with appropriate config

exec sql "insert into t4 values ('Spears', 'Britney')"
exec sql "select * from t4 where k0='Spears'"
exec sql "select * from t4 where k1='Britney'"
# try to insert the incoplete tuple
exec sql "insert into t4 values ('Spears')"
# check that nothing has been updated
exec sql "select * from t4 where k0='Spears'"
# cleanup
exec sql "delete from t4 where k0='Spears'"

# vim: syntax=python
