# encoding: tarantool
# 
import sys


print "================ semaphores ======================="
exec admin "lua sm = box.ifc.semaphore(1)"
exec admin "lua sm.up()"
exec admin "lua sm.up({})"

exec admin "lua sm:up()"
exec admin "lua sm()"
exec admin "lua sm:up()"
exec admin "lua sm()"
exec admin "lua sm:down()"
exec admin "lua sm()"
exec admin "lua sm:down(.1)"
exec admin "lua sm()"
exec admin "lua sm:trydown()"
exec admin "lua sm()"
# next call will lock semaphore


exec admin "lua sm()"
exec admin "lua sm:trydown()"
exec admin "lua sm:trydown()"
exec admin "lua sm:down(.5)"


exec admin "lua state = {}"
exec admin "lua tfbr = box.fiber.create(function() box.fiber.detach() table.insert(state, 'tfbr started') sm:down() table.insert(state, 'tfbr') sm:up() end) box.fiber.resume(tfbr)"

exec admin "lua tfbrd = box.fiber.create(function() box.fiber.detach() table.insert(state, 'tfbrd started') sm:down() table.insert(state, 'tfbrd') sm:up() end) box.fiber.resume(tfbrd)"

exec admin "lua box.fiber.sleep(.5)"

exec admin "lua  for k, v in pairs(state) do print(k, ': ', v) end"

exec admin "lua sm()"
exec admin "lua box.fiber.cancel(tfbrd)"
exec admin "lua sm()"
exec admin "lua sm:up()"
exec admin "lua box.fiber.sleep(.5)"
exec admin "lua  for k, v in pairs(state) do print(k, ': ', v) end"


print "================ mutexes ======================="

exec admin "lua m = box.ifc.mutex()"
exec admin "lua m:locked()"
exec admin "lua print(m())"
exec admin "lua flag = 0"
exec admin "lua m:lock()"
exec admin "lua m:locked()"
exec admin "lua tfbr = box.fiber.create(function() box.fiber.detach() m:lock() flag = 1 m:unlock() end)"
exec admin "lua box.fiber.resume(tfbr)"
exec admin "lua print(flag)"
exec admin "lua box.fiber.sleep(.5)"
exec admin "lua m:trylock()"
exec admin "lua m:unlock()"
exec admin "lua print(flag)"
exec admin "lua m:locked()"
exec admin "lua m:lock(.1)"
exec admin "lua m:locked()"
exec admin "lua m:lock(.1)"
exec admin "lua m:locked()"

exec admin "lua m = nil"
exec admin "lua print(m)"


print "================ channels ======================="
exec admin "lua ch = box.ifc.channel()"
exec admin "lua ch:is_full()"
exec admin "lua ch:is_empty()"
exec admin "lua ch:get(.1)"
exec admin "lua ch:put()"
exec admin "lua ch:put('test')"
exec admin "lua ch:get()"
exec admin "lua ch:get('wrong timeout')"
exec admin "lua ch:get(-10)"
exec admin "lua ch:put(234)"
exec admin "lua ch:put(345, .5)"
exec admin "lua ch:is_full()"
exec admin "lua ch:is_empty()"
exec admin "lua buffer = {}"
exec admin "lua tfbr = box.fiber.create(function() box.fiber.detach() while true do table.insert(buffer, ch:get()) end end)"
exec admin "lua box.fiber.resume(tfbr)"
exec admin "lua for i = 1, 10 do ch:put(i) box.fiber.sleep(0.01) end"
exec admin "lua box.fiber.sleep(.5)"
exec admin "lua ch:has_readers()"
exec admin "lua ch:has_writers()"
exec admin "lua box.fiber.cancel(tfbr)"
exec admin "lua ch:has_readers()"
exec admin "lua ch:has_writers()"
exec admin "lua ch:put(box.info.pid)"
exec admin "lua ch:is_full()"
exec admin "lua ch:is_empty()"
exec admin "lua ch:get(box.info.pid) == box.info.pid"
exec admin "lua for i, v in pairs(buffer) do print(v) end"

exec admin "lua ch:is_empty()"
exec admin "lua ch:broadcast()"
exec admin "lua ch:broadcast(123)"
exec admin "lua ch:get()"

exec admin "lua ch:is_full()"
exec admin "lua ch:is_empty()"
exec admin "lua tfbr = box.fiber.create(function() box.fiber.detach() while true do local v = ch:get() table.insert(buffer, 'tfbr  - ' .. tostring(v)) end end)"
exec admin "lua box.fiber.resume(tfbr)"
exec admin "lua tfbr2 = box.fiber.create(function() box.fiber.detach() while true do local v = ch:get() table.insert(buffer, 'tfbr2 - ' .. tostring(v)) end end)"
exec admin "lua box.fiber.resume(tfbr2)"

exec admin "lua buffer = {}"
exec admin "lua box.fiber.sleep(2)"

exec admin "lua for i, v in pairs(buffer) do print(v) end"
exec admin "lua ch:is_full()"
exec admin "lua ch:is_empty()"
exec admin "lua ch:put(1)"
exec admin "lua ch:put(2)"
exec admin "lua ch:put(3)"
exec admin "lua ch:put(4)"
exec admin "lua ch:put(5)"
exec admin "lua box.fiber.sleep(0.5)"
exec admin "lua ch:broadcast('broadcast message!')"
exec admin "lua for i = 35, 45 do print(ch:put(i)) end"


exec admin "lua for i, v in pairs(buffer) do print(v) end"

