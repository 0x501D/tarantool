--
-- Check a double create space
--
s = box.schema.create_space('test')
---
...
s = box.schema.create_space('test')
---
- error: Space 'test' already exists
...
--
-- Check a double drop space
--
s:drop()
---
...
s:drop()
---
- error: Space 512 does not exist
...
--
-- Check double create user
--
box.schema.user.create('testus')
---
...
box.schema.user.create('testus')
---
- error: User 'testus' already exists
...
s = box.schema.create_space('admin_space')
---
...
s:create_index('primary', {type = 'hash', parts = {0, 'NUM'}})
---
...
s:insert({1})
---
- [1]
...
--
-- Check double grant
--
box.schema.user.grant('testus', 'read', 'space', 'admin_space')
---
...
box.schema.user.grant('testus', 'read', 'space', 'admin_space')
---
...
box.session.su('testus')
---
...
s:select()
---
- - [1]
...
--
-- Check double revoke
--
box.session.su('admin')
---
...
box.schema.user.revoke('testus', 'read', 'space', 'admin_space')
---
...
box.schema.user.revoke('testus', 'read', 'space', 'admin_space')
---
...
box.session.su('testus')
---
...
s:select()
---
- error: Read access denied for user 'testus' to space 'admin_space'
...
box.session.su('admin')
---
...
--
-- Check double drop user
--
box.schema.user.drop('testus')
---
...
box.schema.user.drop('testus')
---
- error: User 'testus' does not exist
...
--
-- Check 'guest' user
--
box.session.su('guest')
---
...
box.session.uid()
---
- 0
...
box.space._user:select()
---
- error: Read access denied for user 'guest' to space '_user'
...
s:select()
---
- error: Read access denied for user 'guest' to space 'admin_space'
...
box.session.su('admin')
---
...
-- Create user with universe read&write grants
-- and create this user session
--
box.schema.user.create('uniuser')
---
...
box.schema.user.grant('uniuser', 'read, write, execute', 'universe')
---
...
box.session.su('uniuser')
---
...
box.session.uid()
---
- 2
...
--
-- Check universal user
-- Check delete currently authenticated user
--
box.schema.user.drop('uniuser')
---
- error: Write access denied for user 'uniuser'
...
--
--Check create, call and drop function
--
box.schema.func.create('uniuser_func')
---
...
function uniuser_func() return 'hello' end
---
...
uniuser_func()
---
- hello
...
box.schema.func.drop('uniuser_func')
---
...
--
-- Check create and drop space
--
us = box.schema.create_space('uniuser_space')
---
...
us:drop()
---
...
--
-- Check create and drop user
--
box.schema.user.create('uniuser_testus')
---
...
box.schema.user.drop('uniuser_testus')
---
- error: Write access denied for user 'uniuser'
...
--
-- Check access system and any spaces
--
box.space.admin_space:select()
---
- - [1]
...
box.space._user:select()
---
- - [0, '', 'guest']
  - [1, '', 'admin']
  - [2, '', 'uniuser', []]
  - [3, '', 'uniuser_testus', []]
...
box.space._space:select()
---
- - [272, 1, '_schema', 'memtx', 0]
  - [280, 1, '_space', 'memtx', 0]
  - [288, 1, '_index', 'memtx', 0]
  - [296, 1, '_func', 'memtx', 0]
  - [304, 1, '_user', 'memtx', 0]
  - [312, 1, '_priv', 'memtx', 0]
  - [512, 1, 'admin_space', 'memtx', 0, '']
...
us = box.schema.create_space('uniuser_space')
---
...
box.schema.func.create('uniuser_func')
---
...
box.schema.user.create('uniuser_testus')
---
- error: User 'uniuser_testus' already exists
...
box.session.su('admin')
---
...
box.schema.user.create('someuser')
---
...
box.schema.user.grant('someuser', 'read, write, execute', 'universe')
---
...
box.session.su('someuser')
---
...
--
-- Check drop objects of another user
--
s:drop()
---
- error: Write access denied for user 'someuser'
...
us:drop()
---
- error: Write access denied for user 'someuser'
...
box.schema.func.drop('uniuser_func')
---
- error: Write access denied for user 'someuser'
...
box.schema.user.drop('uniuser_testus')
---
- error: Write access denied for user 'someuser'
...
box.session.su('admin')
---
...
box.schema.func.drop('uniuser_func')
---
...
box.schema.user.drop('someuser')
---
...
box.schema.user.drop('uniuser_testus')
---
...
box.schema.user.drop('uniuser')
---
- error: Function '513' does not exist
...
box.space._user:delete(2)
---
- [2, '', 'uniuser', []]
...
--
-- Check write grant on _user
--
box.schema.user.create('testuser')
---
...
box.schema.user.grant('testuser', 'write', 'space', '_user')
---
...
box.session.su('testuser')
---
...
box.space._user:delete(2)
---
- error: 'Failed to drop user ''testuser'': the user has objects'
...
box.space._user:select()
---
- error: Read access denied for user 'testuser' to space '_user'
...
box.space._user:insert{3,'','someone'}
---
- [3, '', 'someone']
...
box.space._user:delete(3)
---
- error: Write access denied for user 'testuser'
...
box.session.su('admin')
---
...
box.space._user:select()
---
- - [0, '', 'guest']
  - [1, '', 'admin']
  - [2, '', 'testuser', []]
  - [3, '', 'someone']
...
box.schema.user.revoke('testuser', 'write', 'space', '_user')
---
...
--
-- Check read grant on _user
--
box.schema.user.grant('testuser', 'read', 'space', '_user')
---
...
box.session.su('testuser')
---
...
box.space._user:delete(2)
---
- error: Write access denied for user 'testuser' to space '_user'
...
box.space._user:select()
---
- - [0, '', 'guest']
  - [1, '', 'admin']
  - [2, '', 'testuser', []]
  - [3, '', 'someone']
...
box.space._user:insert{4,'','someone2'}
---
- error: Write access denied for user 'testuser' to space '_user'
...
box.session.su('admin')
---
...
--
-- Check read grant on _index
--
box.schema.user.grant('testuser', 'read', 'space', '_index')
---
...
box.session.su('testuser')
---
...
box.space._index:select()
---
- - [272, 0, 'primary', 'tree', 1, 1, 0, 'str']
  - [280, 0, 'primary', 'tree', 1, 1, 0, 'num']
  - [280, 1, 'owner', 'tree', 0, 1, 1, 'num']
  - [280, 2, 'name', 'tree', 1, 1, 2, 'str']
  - [288, 0, 'primary', 'tree', 1, 2, 0, 'num', 1, 'num']
  - [288, 2, 'name', 'tree', 1, 2, 0, 'num', 2, 'str']
  - [296, 0, 'primary', 'tree', 1, 1, 0, 'num']
  - [296, 1, 'owner', 'tree', 0, 1, 1, 'num']
  - [296, 2, 'name', 'tree', 1, 1, 2, 'str']
  - [304, 0, 'primary', 'tree', 1, 1, 0, 'num']
  - [304, 2, 'name', 'tree', 1, 1, 2, 'str']
  - [312, 0, 'primary', 'tree', 1, 3, 1, 'num', 2, 'str', 3, 'num']
  - [312, 1, 'owner', 'tree', 0, 1, 1, 'num']
  - [512, 0, 'primary', 'hash', 1, 1, 0, 'NUM']
...
box.space._index:insert{512, 1,'owner','tree', 1, 1, 0,'num'}
---
- error: Write access denied for user 'testuser' to space '_index'
...
box.session.su('admin')
---
...
--
-- Check max function limit
--
--# setopt delimiter ';'
function func_limit()
    local i = 1
    while i <= 32001 do
        box.schema.func.create('func'..i)
        i = i + 1
    end
    return i
end;
---
...
func_limit();
---
- error: 'A limit on the total number of functions has been reached: 32000'
...
--# setopt delimiter ''
s:drop()
---
...
box.space._user:select()
---
- - [0, '', 'guest']
  - [1, '', 'admin']
  - [2, '', 'testuser', []]
  - [3, '', 'someone']
...
