# encoding: tarantool
#
import sys
# clear statistics:
server.stop()
server.deploy()

exec admin "show injections"
exec admin "set injection some-injection on"
exec sql "select * from t0 where k0 = 222444"
exec admin "set injection ERRINJ_TESTING on"
exec sql "select * from t0 where k0 = 222444"
exec admin "set injection ERRINJ_TESTING off"

# Check how well we handle a failed log write.
exec admin "set injection ERRINJ_WAL_IO on"
exec sql "insert into t0 values (1)"
exec sql "select * from t0 where k0=1"
exec admin "set injection ERRINJ_WAL_IO off"
exec sql "insert into t0 values (1)"
exec admin "set injection ERRINJ_WAL_IO on"
exec sql "update t0 set k0=2 where k0=1"
exec sql "select * from t0 where k0=1"
exec sql "select * from t0 where k0=2"
exec admin "set injection ERRINJ_WAL_IO off"
exec admin "lua box.space[0]:truncate()"

# Check a failed log rotation.
exec admin "set injection ERRINJ_WAL_ROTATE on"
exec sql "insert into t0 values (1)"
exec sql "select * from t0 where k0=1"
exec admin "set injection ERRINJ_WAL_ROTATE off"
exec sql "insert into t0 values (1)"
exec admin "set injection ERRINJ_WAL_ROTATE on"
exec sql "update t0 set k0=2 where k0=1"
exec sql "select * from t0 where k0=1"
exec sql "select * from t0 where k0=2"
exec admin "set injection ERRINJ_WAL_ROTATE off"
exec sql "update t0 set k0=2 where k0=1"
exec sql "select * from t0 where k0=1"
exec sql "select * from t0 where k0=2"
exec admin "set injection ERRINJ_WAL_ROTATE on"
exec admin "lua box.space[0]:truncate()"
exec admin "set injection ERRINJ_WAL_ROTATE off"
exec admin "lua box.space[0]:truncate()"

# Check a failed realloc in tree.
server.stop()
server.deploy("box/tarantool_tree_alloc.cfg")
exec admin "lua for i = 1,10 do box.space[0]:insert(i, i, 'testtesttest') end"
exec admin "set injection ERRINJ_TREE_ALLOC on"
exec admin "lua for i = 11,1000 do box.space[0]:insert(i, i) end"
exec admin "lua box.space[0].index[0]:iterator(box.index.ALL)"
exec admin "set injection ERRINJ_TREE_ALLOC off"
exec admin "lua for i = 1,10 do print(box.space[0]:select(0, i)) end"
exec admin "lua box.space[0]:truncate()"
server.stop()
server.deploy(self.suite_ini["config"])

# vim: syntax=python
